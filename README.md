## MegaD для Home Assistant
*Неофициальная версия интеграции.*

![python version](https://img.shields.io/badge/Python-3.13-yellowgreen?style=plastic&logo=python)
![pydantic version](https://img.shields.io/badge/pydantic-ha-yellowgreen?style=plastic&logo=fastapi)
![aiohttp version](https://img.shields.io/badge/aiohttp-ha-yellowgreen?style=plastic)
![Home Assistant](https://img.shields.io/badge/HomeAssistant-latest-yellowgreen?style=plastic&logo=homeassistant)

#### Поддержать разработку

[![Donate](https://img.shields.io/badge/donate-Tinkoff-FFDD2D.svg)](https://www.tinkoff.ru/rm/shutov.mikhail19/wUyu873109)

## Описание
Компонент для управления устройствами [MegaD](https://ab-log.ru/) из Home Assistant. 
Работоспособность проверялась на прошивке версии 4.64b6 (моноблок).

> [!WARNING]
> !!! Для корректной работы интеграции после каждого обновления конфигурации
> контроллера необходимо обновить конфигурационный файл и инициализировать 
> все устройства в НА.

> [!WARNING]
> Интеграция находится на начальной стадии разработки.
> Ниже приведён функционал на данный момент.
 
## Возможности.
### Конфигурация.
Интеграция умеет сохранять конфигурацию контроллера и записывать её обратно в MegaD.
Если что-то случится с устройством, то можно заменить его и записать сохранённую 
конфигурацию. И не придётся настраивать всё вручную.

### Бинарные сенсоры.
В НА добавляются порты в качестве бинарного сенсора только те порты IN у которых в интерфейсе
MegaD в поле "Mode" стоит значение "P&R" или значения "P", "R" но если установлена
галочка ☑ у этого поля. В противном случае порт будет добавлен как [счетчик](#счётчики) или [сенсор кнопки](#сенсоры-кнопок)
В поле "Title" порта (настройка MegaD) можно указать название сенсора, его тип и инверсию.
**Помните, что контроллер ограничивает это поле 25 символами.**

Формат: имя сенсора/тип устройства/инверсия
* Имя устройства может быть любым, главное ограничение количество символов
* Тип устройства состоит из 1 или 2 букв английского алфавита. Поддерживаемые типы устройств:
    - Движение (motion) -> m
    - Окно (window) -> w
    - Дверь (door) -> d
    - Гаражные ворота (garage_door) -> gd
    - Замок (lock) -> l
    - Обнаружение влаги (moisture) -> ms
    - Обнаружение дыма (smoke) -> s
* Инверсия имеет значения 1 или 0. По умолчанию 0.

> ✳ при необходимости поддержи других типов, создавайте issues.

Примеры:
* Дверь/d -> Имя "Дверь" / Тип в НА door / инверсии нет
* Коридор/m/1 -> Имя "Коридор" / Тип в НА motion / инверсия установлена
* Плита -> Имя "Плита" / Тип в НА None / инверсии нет

### Сенсоры кнопок.

Порты IN которые настроены в режиме "Click", добавляются в НА как сенсоры кнопок.

Возможные состояния такого сенсора:
* single -> одиночное нажатие
* double -> двойное нажатие
* long -> длительное нажатие
* off -> состояние по умолчанию

### Счётчики.

У каждого порта с типом "IN" есть дополнительный параметр число срабатывания порта.
Это число добавляется в НА отдельным сенсором. Логику работы счётчика смотрите 
в [документации MegaD](https://ab-log.ru/smart-house/ethernet/megad-2561#conf-in-cnt).

### Релейные выходы.

По умолчанию релейные выходы в НА добавляются как switch. 
В поле "Title" порта (настройка MegaD) можно указать название устройства, его тип.
Ограничение поля по длине 25 символов.

Формат: имя сенсора/тип устройства
* Имя устройства может быть любым, главное ограничение количество символов
* Тип устройства состоит из 1 или 2 букв английского алфавита. Поддерживаемые типы устройств:
    - Переключатель (switch) -> s
    - Освещение (light) -> l
    - Вентиляция (fan) -> f

> ✳ при необходимости поддержи других типов, создавайте issues.

### Групповые переключатели.

В настройках контроллера есть такое понятие как группы устройств. Интеграция 
добавляет такие группы как отдельный переключатель (switch). Подробней о настройке
групп смотрите в [документации](https://ab-log.ru/smart-house/ethernet/megad-2561#conf-out-gr).
Использование групповых переключателей снижает нагрузку на контроллер.

### Диммируемые выходы.

В НА диммируемые выходы добавляются как освещение (light). Есть возможность изменить
тип устройства в поле "Title".

Формат: имя сенсора/тип устройства
* Имя устройства может быть любым, главное ограничение количество символов
* Тип устройства состоит из 1 или 2 букв английского алфавита. Поддерживаемые типы устройств:
    - Освещение (light) -> l
    - Вентиляция (fan) -> f

> ✳ при необходимости поддержи других типов, создавайте issues.

## В планах

- [x] ~~Добавление бинарных сенсоров с настройкой класса устройства для НА~~
- [x] ~~Добавление сенсоров кнопок с поддержкой одиночного, двойного, долгого нажатий~~
- [x] ~~Добавление сенсоров счётчиков от портов с типом "IN"~~
- [x] ~~Добавление релейных выходов с настройкой класса устройства для НА~~
- [ ] Поддержка управления группами созданных в настройках контроллера
- [ ] Добавление диммируемых выходов в НА
- [ ] Первый релиз интеграции для HACS
- [ ] Добавление 1wire сенсоров
- [ ] Добавление сенсоров dht сенсоров
- [ ] Добавление I2C сенсоров
- [ ] Добавление терморегуляторов в НА
- [ ] Обновление прошивки контроллера из НА

*Свои предложения можете писать в issues*

## Установка.
На данном этапе установка возможна только путём копирования интеграции в каталог
custom_components.
